AWSTemplateFormatVersion: "2010-09-09"
Description: Master template that set up DataHub Platform in AWS
Metadata:
    AWS::CloudFormation::Interface:
      ParameterGroups:
        - Label:
            default: Nested CFN Templates Location
          Parameters:
            - TemplateBucketName
            - Environment
        - Label:
            default: Existing VPC Configuration (leave it alone when creating New VPC)
          Parameters:
            - VPCID
            - AvailabilityZones
            - PrivateSubnet1ID
            - PrivateSubnet2ID
            - PrivateSubnet3ID
            - PublicSubnet1ID
            - PublicSubnet2ID
            - PublicSubnet3ID
        - Label:
            default: ElasticSearch Stack Configuration
          Parameters:
            - CreateElasticSearchServiceRole
            - CreateElasticSearch
            - ESDataNodeCount
            - ESInstanceType
            - ESVolumeSize
            - ESMasterNodeCount
            - ESMasterInstanceType
            - ElasticsearchVersion
        - Label:
            default: MySQL Stack Configuration
          Parameters:
            - CreateMySQL
            - DBInstanceClass
            - EngineVersion
        - Label:
            default: MSK Stack Configuration
          Parameters:
            - CreateMSK
            - KafkaVersion
            - MSKInstanceType
            - MSKVolumeSize
            - NumberOfBrokerNodes
        - Label:
            default: EKS Control Panel Configuration
          Parameters:
            - CreateEKS
            - ProvisionInstanceType
            - AdditionalEKSAdminRoleArn
            - AdditionalEKSAdminUserArn
            - KubernetesVersion
        - Label:
            default: AWSQSEKS Control Panel Configuration
          Parameters:
            - CreateAWSQSEKS
            - ProvisionBastionHost
            - ALBIngressController
            - PrometheusIntegration
            - AdditionalEKSAdminRoleArn
            - AdditionalEKSAdminUserArn
            - KubernetesVersion
            - RemoteAccessCIDR
            - KeyPairName
            #- ConfigSetName
            - PerAccountSharedResources
            - PerRegionSharedResources
            - EKSPublicAccessEndpoint
            #- EKSPrivateAccessEndpoint
            - EKSClusterLoggingTypes
        - Label:
            default: EKS Node Group Configuration
          Parameters:
            - NodeInstanceType
            - MaxNumberOfNodes
            - MinNumberOfNodes
            - DesiredNumberOfNodes
            - EKSNodeVolumeSize
        - Label:
            default: Ingress Controller Stack Configuration
          Parameters:
            - ControllerHostNetwork
        - Label:
            default: Admin Stack Configuration
          Parameters:
            - CreateAdmin
            - DomainName
            - ElbInboundCIDRs
            - ElbCertArn 
            - KotsDomainName
            - KotsElbCertArn 
            - KotsAdmNLBScheme
            - ProvisionInstanceType
            - Application
            - ApplicationReleaseChannel
        - Label:
            default: PrivateLink Stack Configuration
          Parameters:
            - CreatePrivateLink
        - Label:
            default: Remove Admin Provision Host
          Parameters:
            - RemoveTempResources

      ParameterLabels:
        VPCID:
          Default: The Existing VPC ID
        PrivateSubnet1ID:
          Default: The Existing Private Subnet 1 ID
        PrivateSubnet2ID:
          Default: The Existing Private Subnet 2 ID
        PrivateSubnet3ID:
          Default: The Existing Private Subnet 3 ID
        PublicSubnet1ID:
          Default: The Existing Public Subnet 1 ID
        PublicSubnet2ID:
          Default: The Existing Public Subnet 2 ID
        PublicSubnet3ID:
          Default: The Existing Public Subnet 3 ID

        AvailabilityZones:
          default: The AZ's to deploy to.
        ProvisionInstanceType:
          default: The instance type to deploy Provision to
        NodeInstanceType:
          default: The instance type to deploy EKS Worker Node to
        MaxNumberOfNodes:
          default: The maximum number of nodes to scale up to for each EKS Worker Node Group
        MinNumberOfNodes:
          default: The minimum number of nodes to scale down to for each EKS Worker Node Group
        DesiredNumberOfNodes:
          default: The desired number of nodes to keep running for each EKS Worker Node Group
        EKSNodeVolumeSize:
          default: The Volume size of EKS Worker Node
        TemplateBucketName:
          default: The name of the S3 bucket that holds the templates
        Environment:
          default: The Environment Prefix
        AdditionalEKSAdminRoleArn:
          default: The AWS IAM Role arn that will be allowed to manage EKS. Note do not include path just name of role like my-role
        AdditionalEKSAdminUserArn:
          default: The AWS IAM user arn who will be authorised to connect the cluster
        KubernetesVersion:
          default: The Kubernetes Version
        EKSClusterLoggingTypes:
          default: EKS Cluster Logging Types List
        EKSPublicAccessEndpoint:
          default: Enable EKSPublicAccessEndpoint
        #EKSPrivateAccessEndpoint:
        #  default: Enable EKSPrivateAccessEndpoint
        RemoteAccessCIDR:
          default: Allowed external access CIDR
        KeyPairName:
          default: SSH key name
        #ConfigSetName:
        #  default: Config set name
        PerAccountSharedResources:
          default: Per-account shared resources
        PerRegionSharedResources:
          default: Per-Region shared resources
        CreateElasticSearch:
          default: Enable Creation of ElasticSearch
        CreateElasticSearchServiceRole:
          default: Enable Creation of ElasticSearch Service Role
        CreateMSK:
          default: Enable Creation of MSK
        CreateMySQL:
          default: Enable Creation of Aurora RDS
        CreateEKS:
          default: Enable Creation of EKS
        CreateAWSQSEKS:
          default: Enable Creation of AWSQSEKS
        ProvisionBastionHost:
          default: Provision bastion host
        PrometheusIntegration:
          default: Prometheus integration
        ALBIngressController:
          default: AWS load balancer controller
        CreateAdmin:
          default: Enable Creation of Admin
        CreatePrivateLink:
          default: Enable Creation of PrivateLink
        RemoveTempResources:
          default: Enable Deletion of Temp Resources
        ESDataNodeCount:
          default: ES Data Node Instance Count 
        ESMasterNodeCount:
          default: ES Master Node Instance Count 
        ESInstanceType:
          default: The ElasticSearch Data Node Instance Type
        ESVolumeSize:
          default: The ElasticSearch Data Node Volume Size
        ESMasterInstanceType:
          default: The ElasticSearch Master Node Instance Type
        ElasticsearchVersion:
          default: The ElasticSearch Version
        DBInstanceClass:
          default: Aurora Instance Type
        EngineVersion:
          default: Aurora Engine Version
        KafkaVersion:
          default: Kafka Version
        MSKInstanceType:
          default: MSK Instance Type
        MSKVolumeSize:
          default: The MSK Volume Size
        NumberOfBrokerNodes:
          default: The Number of MSK Brokers
        ControllerHostNetwork:
          default: Deploy EKS load balancer controller
        ElbCertArn:
          default: DataHub ALB cert arn
        KotsElbCertArn:
          default: KotsAdmin NLB cert arn
        ElbInboundCIDRs:
          default: DataHub ALB Inbound CIDRs
        DomainName:
          default: DataHub Domain Name
        KotsDomainName:
          default: Kots Admin Domain Name
        KotsAdmNLBScheme:
          default: Kots Admin Load Balancer Scheme
        Application:
          default: Application Name
        ApplicationReleaseChannel:
          default: Application Release Channel

Parameters:
    VPCID: 
      #Default: "vpc-1234" 
      Default: "vpc-03042805f5912d718" 
      Type: String
    AvailabilityZones:
      Description: "List of Availability Zones to use for the subnets in the VPC. Please choose three zones."
      Type: "List<AWS::EC2::AvailabilityZone::Name>"
    PrivateSubnet1ID: 
      Type: "AWS::EC2::Subnet::Id"
      Default: "subnet-0127a3f6a25ae5b7e"
    PrivateSubnet2ID: 
      Type: String
      #Default: "" 
      Default: "subnet-06ca286c2d8ef5d80" 
    PrivateSubnet3ID:
      Type: String
      Default: ""
    PublicSubnet1ID: 
      Type: String
      #Default: "" 
      Default: "subnet-0127a3f6a25ae5b7e"
    PublicSubnet2ID: 
      Type: String
      #Default: "" 
      Default: "subnet-06ca286c2d8ef5d80" 
    PublicSubnet3ID:
      Default: ""
      Type: String
    ProvisionInstanceType:
      Type: "String"
      Default: "t2.micro"
      Description: "The type of EC2 instance to be launched for Provision Host"
      AllowedValues:
        - t2.micro
        - t2.medium
        - t2.large
      ConstraintDescription: "Must contain a valid instance type"
    NodeInstanceType:
      Type: "String"
      Default: "m5.large"
      Description: "The type of EC2 instance to be launched for EKS Worker Node"
      AllowedValues:
        - t2.xlarge
        - t2.2xlarge
        - m3.xlarge
        - m3.2xlarge
        - m4.xlarge
        - m4.2xlarge
        - m5.large
        - m5.xlarge
        - m5.2xlarge
      ConstraintDescription: "Must contain a valid instance type"
    DesiredNumberOfNodes:
      Type: String
      MinLength: 1
      Description: "The desired number of EKS Worker Nodes to run for each group"
      Default: "1"
    EKSNodeVolumeSize:
      Type: String
      Description: "The EKS Worker Node Volume Size in GB"
      Default: "50"
    MaxNumberOfNodes:
      Type: String
      MinLength: 1
      Description: "The maximum number of EKS Worker Nodes to run for each group"
      Default: "1"
    MinNumberOfNodes:
      Type: String
      MinLength: 1
      Description: "The minimum number of EKS Worker Nodes to run for each group"
      Default: "1"
    TemplateBucketName:
      AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
      ConstraintDescription: "Bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
      Description: "S3 bucket name that contains the CFN templates (VPC, Provision etc). This string can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
      Type: "String"
    Environment:
      AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z]*[0-9a-zA-Z])*$"
      Description: "The Environment Prefix"
      Type: "String"
      Default: "dev"
    AdditionalEKSAdminRoleArn:
      Type: String
      Description: The AWS IAM role arn that will have manage access to EKS
      Default: "arn:aws:iam::577660233792:role/blrxgroup-privaceracloud-role"
    AdditionalEKSAdminUserArn:
      Type: String
      Description: "The AWS IAM user arn who will be authorised to connect the cluster. Note format is arn:aws:iam::123456789:user/user1"
      Default: "arn:aws:iam::577660233792:user/blrxgroup-dev-admin"
    KubernetesVersion:
      Description: "The Kubernetes Version"
      Type: String
      Default: "1.18"
      AllowedValues:
        - "1.18"
        - "1.21"
    EKSPublicAccessEndpoint:
      Description: "Set to Enabled if you want to enable EKSPublicAccessEndpoint"
      Type: String
      AllowedValues: [Enabled, Disabled]
      #Default: Disabled
      Default: Enabled
    #EKSPrivateAccessEndpoint:
    #  Description: "Set to Enabled if you want to enable EKSPrivateAccessEndpoint"
    #  Type: String
    #  AllowedValues: [Enabled, Disabled]
    #  Default: Enabled
    RemoteAccessCIDR:
      AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
      ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
      Description: CIDR IP range that is permitted to access the instances. We recommend that you set this value to a trusted IP range.
      Type: String
      Default: 0.0.0.0/0
    KeyPairName:
      Description: Name of an existing key pair, which allows you to securely connect to your instance after it launches.
      Type: String
      Default: ""
    #ConfigSetName:
    #  Type: String
    #  Default: ""
    #  Description: >-
    #    (Optional) Name used to map advanced parameters to an EKS cluster. If you launched an advanced
    #    configuration stack and would like to apply it's values to this cluster, this name must match the "Config set name"
    #    parameter in that stack. If left blank, a new config set is created using default values.
    PerAccountSharedResources:
      Type: String
      AllowedValues: ['AutoDetect', 'Yes', 'No']
      Default: 'AutoDetect'
      Description: Choose "No" if you already deployed another EKS Quick Start stack in your AWS account.
    PerRegionSharedResources:
      Type: String
      AllowedValues: ['AutoDetect', 'Yes', 'No']
      Default: 'AutoDetect'
      Description: Choose "No" if you already deployed another EKS Quick Start stack in your Region.
    EKSClusterLoggingTypes:
      Type: List<String>
      Default: "api,audit,authenticator,controllerManager,scheduler"
    CreateElasticSearchServiceRole:
      Description: "Set to true if IAM Role AWSServiceRoleForAmazonElasticsearchService doesn't exist"
      Type: String
      Default: "false"
      AllowedValues:
        - "true"
        - "false"
    CreateElasticSearch:
      Description: "Set to true to create ElasticSearch"
      Type: String
      Default: "true"
      AllowedValues:
        - "true"
        - "false"
    CreateMySQL:
      Description: "Set to true if you want to create MySQL"
      Type: String
      Default: "true"
      AllowedValues:
        - "true"
        - "false"
    CreateMSK:
      Description: "Set to true if you want to create MSK"
      Type: String
      Default: "true"
      AllowedValues:
        - "true"
        - "false"
    CreateEKS:
      Description: "Set to true if you want to create EKS"
      Type: String
      Default: "false"
      AllowedValues:
        - "true"
        - "false"
    CreateAWSQSEKS:
      Description: "Set to true if you want to create AWSQSEKS"
      Type: String
      Default: "true"
      AllowedValues:
        - "true"
        - "false"
    ProvisionBastionHost:
      Type: String
      AllowedValues: [ "Enabled", "Disabled" ]
      Default: "Disabled"
      Description: Choose "Disabled" to skip creating a bastion host.
    # This parameter name is inaccurate to preserve backward compatibility, and will be changed to ALBIngressController in the next release
    ALBIngressController:
      Type: String
      AllowedValues: [ "Enabled", "Disabled" ]
      Default: "Enabled"
      Description: Choose "Enabled" to deploy the AWS load balancer controller.
    PrometheusIntegration:
      Type: String
      AllowedValues: [ Enabled, Disabled ]
      Default: Enabled
      Description: 'For more information see https://prometheus.io/ .'
    CreateAdmin:
      Description: "Set to true if you want to create Admin"
      Type: String
      Default: "true"
      AllowedValues:
        - "true"
        - "false"
    CreatePrivateLink:
      Description: "Set to true if you want to create PrivateLink"
      Type: String
      Default: "false"
      AllowedValues:
        - "true"
        - "false"
    RemoveTempResources:
      Description: "Set to true if you don't want to keep admin provision host"
      Type: String
      Default: "true"
      AllowedValues:
        - "true"
        - "false"
    ESVolumeSize:
      Default: 50
      Description: Data Node Volume Size in GB
      Type: String
    ESDataNodeCount:
      Default: 4
      Type: String
    ESMasterNodeCount:
      Default: 3
      Type: String
    ESInstanceType:
      Type: "String"
      Default: "m5.large.elasticsearch"
      Description: "The type of EC2 instance to be launched for ElasticSearch Data Node"
      AllowedValues:
        - t3.small.elasticsearch
        - t3.large.elasticsearch
        - m5.large.elasticsearch
    ESMasterInstanceType:
      Type: "String"
      Default: "c5.large.elasticsearch"
      Description: "The type of EC2 instance to be launched for ElasticSearch Master Node"
      AllowedValues:
        - t3.small.elasticsearch
        - t3.large.elasticsearch
        - c5.large.elasticsearch
    ElasticsearchVersion:
      Type: "String"
      Default: "7.9"
      Description: "The Elasticsearch Version"
      AllowedValues:
        - 7.9
    DBInstanceClass:
      AllowedValues:
        - db.t3.small
        - db.t3.large
      ConstraintDescription: Must contain valid RDS instance type
      Default: db.t3.large
      Description: instance type for the Amazon Aurora
      Type: String
    EngineVersion:
      AllowedValues:
        - 5.7.mysql_aurora.2.09.1
      Default: 5.7.mysql_aurora.2.09.1
      Description: Aurora Engine Version
      Type: String
    MSKInstanceType:
      AllowedValues:
        - kafka.t3.small
        - kafka.t3.large
        - kafka.m5.large
      ConstraintDescription: Must contain valid MSK instance type
      Default: kafka.m5.large
      Description: EC2 instance type for the Amazon MSK instances
      Type: String
    MSKVolumeSize:
      Default: 10
      Description: MSK Volume Size in GB
      Type: String
    NumberOfBrokerNodes:
      Default: 4
      Description: The number of MSK Brokers
      Type: String
    KafkaVersion:
      AllowedValues:
        - 2.4.1.1
      Default: 2.4.1.1
      Description: Kafka version
      Type: String
    ControllerHostNetwork:
      Description: Enables Ingress Controller IAM
      Type: String
      Default: "Disabled"
      AllowedValues:
      - "Disabled"
      - "Enabled"
    ElbCertArn:
      ConstraintDescription: The Elastic Load Balancer Cert Arn can not be empty
      Type: String
      Default: "arn:aws:acm:us-west-2:577660233792:certificate/66b92cc0-c78f-4a11-99f3-a6f8586d744f"
    KotsElbCertArn:
      ConstraintDescription: The Elastic Load Balancer Cert Arn can not be empty
      Type: String
      Default: "arn:aws:acm:us-west-2:577660233792:certificate/66b92cc0-c78f-4a11-99f3-a6f8586d744f"
    ElbInboundCIDRs:
      ConstraintDescription: The Elastic Load Balancer Inbound CIDRs
      Type: String
      Default: "10.0.0.0/8,192.0.0.0/8,172.0.0.0/8"
    DomainName:
      Default: "datahub.a.b.c"
      Description: DataHub Domain Name
      Type: String
    KotsDomainName:
      Default: "kotsadm.e.f.g"
      Description: Kots Admin Domain Name
      Type: String
    KotsAdmNLBScheme:
      Description: Kots Admin Load Balancer Scheme
      Type: String
      Default: "internal"
      AllowedValues:
      - "internal"
      - "internet-facing"
    Application:
      Description: Application Name
      Type: String
      Default: "datahub-poc"
      AllowedValues:
      - "datahub-poc"
      - "datahub"
    ApplicationReleaseChannel:
      Description: Application Release Channel
      Type: String
      Default: "unstable"
      AllowedValues:
      - "unstable"
      - "beta"
      - "stable"



Conditions:
  isCreateElasticSearchServiceRole: !Equals [!Ref CreateElasticSearchServiceRole, "true"]
  isCreateElasticSearch:            !Equals [!Ref CreateElasticSearch, "true"]
  isCreateESServiceRole:            !And
    - !Condition isCreateElasticSearchServiceRole
    - !Condition isCreateElasticSearch
  isCreateMySQL:                    !Equals [!Ref CreateMySQL, "true"]
  isCreateMSK:                      !Equals [!Ref CreateMSK, "true"]
  isCreateEKS:                      !Equals [!Ref CreateEKS, "true"]
  isCreateAWSQSEKS:                 !Equals [!Ref CreateAWSQSEKS, "true"]
  isCreateEKSPreRequsite:           !Or
    - !Condition isCreateEKS
    - !Condition isCreateAWSQSEKS
  isCreateAdmin:                    !Equals [!Ref CreateAdmin, "true"]
  isCreatePrivateLink:              !Equals [!Ref CreatePrivateLink, "true"]
   


Resources:

    ESServiceRole:
        Condition: isCreateESServiceRole
        Type: 'AWS::IAM::ServiceLinkedRole'
        Properties:
            AWSServiceName: es.amazonaws.com
            Description: 'Service-linked role to give Amazon ES permissions to access your VPC'

    RDSSecret:
      Condition: isCreateMySQL
      Type: AWS::SecretsManager::Secret
      Properties:
        Name: !Sub "/${Environment}/${AWS::StackName}/mysql/password"
        Description: !Sub "/${Environment}/${AWS::StackName}: Secrets for Aurora MySQL"
        GenerateSecretString:
          SecretStringTemplate: '{"username": "admin"}'
          GenerateStringKey: password
          PasswordLength: 16
          ExcludeCharacters: '#"@/\<>()$?+-`'
          ExcludePunctuation: true
        Tags:
          -
            Key: CloudFormation
            Value: "true"

    ESSecret:
      Condition: isCreateElasticSearch
      Type: AWS::SecretsManager::Secret
      Properties:
        Name: !Sub "/${Environment}/${AWS::StackName}/elasticsearch/password"
        Description: !Sub "/${Environment}/${AWS::StackName}: Secrets for ElasticSearch"
        GenerateSecretString:
          SecretStringTemplate: '{"username": "admin"}'
          GenerateStringKey: password
          PasswordLength: 16
          ExcludeCharacters: '#"@/\<>()$?+-`'
        Tags:
          -
            Key: CloudFormation
            Value: "true"

    KOTSSecret:
      Type: AWS::SecretsManager::Secret
      Properties:
        Name: !Sub "/${Environment}/${AWS::StackName}/kotsadm/password"
        Description: !Sub "/${Environment}/${AWS::StackName}: Secrets for KOTS Admin"
        GenerateSecretString:
          SecretStringTemplate: '{"username": "admin"}'
          GenerateStringKey: password
          PasswordLength: 16
          ExcludeCharacters: '#"@/\<>()$?+-`'
          ExcludePunctuation: true
        Tags:
          -
            Key: CloudFormation
            Value: "true"

    PasswordSecret:
      Type: AWS::SecretsManager::Secret
      Properties:
        Name: !Sub "/${Environment}/${AWS::StackName}/admin/password"
        Description: !Sub "/${Environment}/${AWS::StackName}: Secrets for Admin Password"
        GenerateSecretString:
          SecretStringTemplate: '{"username": "admin"}'
          GenerateStringKey: password
          PasswordLength: 16
          ExcludeCharacters: '#"@/\<>()$?+-`'
          #ExcludePunctuation: true
        Tags:
          -
            Key: CloudFormation
            Value: "true"

    UUIDSecret:
      Type: AWS::SecretsManager::Secret
      Properties:
        Name: !Sub "/${Environment}/${AWS::StackName}/admin/uuid"
        Description: !Sub "/${Environment}/${AWS::StackName}: Secrets for Admin UUID"
        GenerateSecretString:
          SecretStringTemplate: '{"username": "admin"}'
          GenerateStringKey: uuid
          PasswordLength: 32
          ExcludeCharacters: '"@/\<>()$?+-`'
          ExcludePunctuation: true
        Tags:
          -
            Key: CloudFormation
            Value: "true"

    EC2LogGroup:
      Condition: isCreateEKSPreRequsite
      Type: AWS::Logs::LogGroup
      Properties: 
        LogGroupName: !Sub "/${Environment}/${AWS::StackName}/ProvisionHost"

    ProvisionSecurityGroup:
      Condition: isCreateEKSPreRequsite
      Type: AWS::EC2::SecurityGroup
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}-ProvisionHost-SG"
        GroupDescription: Enables SSH Access to Provision Hosts
        VpcId: !Ref VPCID

    NodeInstanceRole:
      Condition: isCreateEKSPreRequsite
      Type: AWS::IAM::Role
      Properties:
        Policies:
          - PolicyName: cloudwatch-logs-policy
            PolicyDocument:
              Version: 2012-10-17
              Statement:
                - Action:
                    - logs:CreateLogStream
                    - logs:GetLogEvents
                    - logs:PutLogEvents
                    - logs:DescribeLogGroups
                    - logs:DescribeLogStreams
                    - logs:PutRetentionPolicy
                    - logs:PutMetricFilter
                  Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${EC2LogGroup}:*"
                  Effect: Allow
          - PolicyName: ebs-volume-policy
            PolicyDocument:
              Version: 2012-10-17
              Statement:
                - Action:
                    - ec2:AttachVolume
                    - ec2:DetachVolume
                  Resource: "arn:aws:ec2:*:*:volume/*"
                  Effect: Allow
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Effect: Allow
            Principal:
              Service:
              - ec2.amazonaws.com
            Action:
            - sts:AssumeRole
        Path: /
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
          - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
          - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
          - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM

    ElasticSearchStack:
      Condition: isCreateElasticSearch
      Type: AWS::CloudFormation::Stack
      DependsOn:
        #- EKSClusterStack
        - EKSPreRequsiteStack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: Datahub-ElasticSearch
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/2-subnets/elasticsearch.yaml"
        Parameters:
          VPCID: !Ref VPCID
          PrivateSubnet1: !Ref PrivateSubnet1ID
          PrivateSubnet2: !Ref PrivateSubnet2ID
          NodeSecurityGroup: !GetAtt AWSQSEKSClusterStack.Outputs.ControlPlaneSecurityGroup
          ESDataNodeCount: !Ref ESDataNodeCount
          ESInstanceType: !Ref ESInstanceType
          ESVolumeSize: !Ref ESVolumeSize
          ESMasterNodeCount: !Ref ESMasterNodeCount
          ESMasterInstanceType: !Ref ESMasterInstanceType
          ESDomainName: !Sub "${AWS::StackName}"
          Environment: !Ref Environment
          EksClusterName: !Sub "${AWS::StackName}"
          ElasticsearchVersion: !Ref ElasticsearchVersion
          ESMasterUserPassword:
            Fn::Sub: "{{resolve:secretsmanager:${ESSecret}::password}}"

    MySQLStack:
      Condition: isCreateMySQL
      Type: AWS::CloudFormation::Stack
      DependsOn:
        #- EKSClusterStack
        - EKSPreRequsiteStack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: Datahub-MySQL
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/2-subnets/mysql.yaml"
        Parameters:
          AvailabilityZones: !Join [",", !Ref AvailabilityZones]
          VPCID: !Ref VPCID
          DBSubnet1: !Ref PrivateSubnet1ID
          DBSubnet2: !Ref PrivateSubnet2ID
          NodeSecurityGroup: !GetAtt AWSQSEKSClusterStack.Outputs.ControlPlaneSecurityGroup
          MasterUser:
            Fn::Sub: "{{resolve:secretsmanager:${RDSSecret}::username}}"
          MasterUserPassword:
            Fn::Sub: "{{resolve:secretsmanager:${RDSSecret}::password}}"
          Environment: !Ref Environment
          EksClusterName: !Sub "${AWS::StackName}"
          DBClusterIdentifier: !Sub "${AWS::StackName}"
          DBInstanceClass: !Ref DBInstanceClass
          EngineVersion: !Ref EngineVersion

    MSKStack:
      Condition: isCreateMSK
      Type: AWS::CloudFormation::Stack
      DependsOn:
        #- EKSClusterStack
        - EKSPreRequsiteStack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: Datahub-MSK
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/2-subnets/msk.yaml"
        Parameters:
          VPCID: !Ref VPCID
          DBSubnet1: !Ref PrivateSubnet1ID
          DBSubnet2: !Ref PrivateSubnet2ID
          NodeSecurityGroup: !GetAtt AWSQSEKSClusterStack.Outputs.ControlPlaneSecurityGroup
          MSKClusterName: !Sub "${AWS::StackName}"
          Environment: !Ref Environment
          EksClusterName: !Sub "${AWS::StackName}"
          MSKInstanceType: !Ref MSKInstanceType
          KafkaVersion: !Ref KafkaVersion
          MSKVolumeSize: !Ref MSKVolumeSize
          NumberOfBrokerNodes: !Ref NumberOfBrokerNodes

    EKSPreRequsiteStack:
      Condition: isCreateEKSPreRequsite
      Type: AWS::CloudFormation::Stack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: !Sub "${AWS::StackName}-EKSPreRequsite"
          - Key: KubernetesCluster
            Value: !Sub "${AWS::StackName}"
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/eks-prerequsite.yaml"
        Parameters:
          VPCID: !Ref VPCID
          TemplateBucketName: !Ref TemplateBucketName
          Environment: !Ref Environment
          ProvisionSecurityGroup: !Ref ProvisionSecurityGroup
          EksClusterName: !Sub "${AWS::StackName}"

    EKSClusterStack:
      Condition: isCreateEKS
      Type: AWS::CloudFormation::Stack
      DependsOn:
        - EKSPreRequsiteStack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: !Sub "${AWS::StackName}-Provision"
          - Key: KubernetesCluster
            Value: !Sub "${AWS::StackName}"
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/2-subnets/eks-cluster.yaml"
        Parameters:
          VPCID: !Ref VPCID
          PublicSubnet1ID: !Ref PublicSubnet1ID
          PublicSubnet2ID: !Ref PublicSubnet2ID
          PrivateSubnet1ID: !Ref PrivateSubnet1ID
          PrivateSubnet2ID: !Ref PrivateSubnet2ID
          ProvisionInstanceType: !Ref ProvisionInstanceType
          TemplateBucketName: !Ref TemplateBucketName
          EC2LogGroup: !Ref EC2LogGroup
          ProvisionSecurityGroup: !Ref ProvisionSecurityGroup
          NodeSecurityGroup: !GetAtt EKSPreRequsiteStack.Outputs.ControlPanelSecurityGroup
          ControlPanelSecurityGroup: !GetAtt EKSPreRequsiteStack.Outputs.ControlPanelSecurityGroup
          EKSServiceRoleArn: !GetAtt EKSPreRequsiteStack.Outputs.EksServiceRoleArn
          NodeInstanceRoleArn: !GetAtt NodeInstanceRole.Arn
          AdditionalEKSAdminRoleArn: !Ref AdditionalEKSAdminRoleArn
          AdditionalEKSAdminUserArn: !Ref AdditionalEKSAdminUserArn
          Environment: !Ref Environment
          KubernetesVersion: !Ref KubernetesVersion
          EksClusterName: !Sub "${AWS::StackName}"
          RemoveTempResources: !Ref RemoveTempResources

    AWSQSEKSClusterProvisionIAMStack:
      Condition: isCreateAWSQSEKS
      Type: AWS::CloudFormation::Stack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: !Sub "${AWS::StackName}-AWSQSEKSClusterProvisionIAM"
          - Key: KubernetesCluster
            Value: !Sub "${AWS::StackName}"
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/2-subnets/awsqseks-cluster-provision-iam.yaml"
        Parameters:
          TemplateBucketName: !Ref TemplateBucketName
          Environment: !Ref Environment
          EksClusterName: !Sub "${AWS::StackName}"
          EC2LogGroup: !Ref EC2LogGroup

    AWSQSEKSClusterStack:
      Condition: isCreateAWSQSEKS
      Type: AWS::CloudFormation::Stack
      DependsOn:
        - AWSQSEKSClusterProvisionIAMStack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: !Sub "${AWS::StackName}-AWSQSEKSCluster"
          - Key: KubernetesCluster
            Value: !Sub "${AWS::StackName}"
#        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/quickstart-amazon-eks/templates/amazon-eks-entrypoint-existing-vpc.template.yaml"
        TemplateURL: "https://cf-amazon-eks-templates-blrxgroup-us-west-2.s3.us-west-2.amazonaws.com/quickstart-amazon-eks/templates/amazon-eks-entrypoint-existing-vpc.template.yaml"
        Parameters:
          #EksClusterName: !Sub "${AWS::StackName}"
          #Environment: !Ref Environment
          #QSS3BucketName: !Ref TemplateBucketName
          #QSS3KeyPrefix: !Sub "${Environment}/"
          EKSClusterName: !Sub "${AWS::StackName}"
          QSS3BucketName: "cf-amazon-eks-templates-blrxgroup-us-west-2"
          VPCID: !Ref VPCID
          PrivateSubnet1ID: !Ref PrivateSubnet1ID
          PrivateSubnet2ID: !Ref PrivateSubnet2ID
          PrivateSubnet3ID: !Ref PrivateSubnet3ID
          PublicSubnet1ID: !Ref PublicSubnet1ID
          PublicSubnet2ID: !Ref PublicSubnet2ID
          PublicSubnet3ID: !Ref PublicSubnet3ID
          RemoteAccessCIDR: !Ref RemoteAccessCIDR
          #SecurityGroupIds: !GetAtt EKSPreRequsiteStack.Outputs.ControlPanelSecurityGroup
          #RoleArn: !GetAtt EKSPreRequsiteStack.Outputs.EksServiceRoleArn
          #AdditionalEKSAdminRoleArn: !Join [",", [!Ref AdditionalEKSAdminRoleArn, !GetAtt NodeInstanceRole.Arn]]
          AdditionalEKSAdminNodeRoleArn: !GetAtt AWSQSEKSClusterProvisionIAMStack.Outputs.ProvisionInstanceRoleArn
          AdditionalEKSAdminRoleArn: !Ref AdditionalEKSAdminRoleArn
          AdditionalEKSAdminUserArn: !Ref AdditionalEKSAdminUserArn
          #KubernetesVersion: !Ref KubernetesVersion
          EKSPublicAccessEndpoint: !Ref EKSPublicAccessEndpoint
          #EKSPrivateAccessEndpoint: !Ref EKSPrivateAccessEndpoint
          #EKSClusterLoggingTypes: !Ref EKSClusterLoggingTypes
          PerAccountSharedResources: !Ref PerAccountSharedResources
          PerRegionSharedResources: !Ref PerRegionSharedResources
          #ConfigSetName: !Ref ConfigSetName
          ConfigSetName: !Sub "${AWS::StackName}"
          ProvisionBastionHost: !Ref ProvisionBastionHost
          ALBIngressController: !Ref ALBIngressController
          PrometheusIntegration: !Ref PrometheusIntegration

    EKSNodeGroupStack:
      Condition: isCreateEKS
      Type: AWS::CloudFormation::Stack
      DependsOn:
        - EKSClusterStack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: !Sub "${AWS::StackName}-Provision"
          - Key: KubernetesCluster
            Value: !Sub "${AWS::StackName}"
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/2-subnets/eks-nodegroup.yaml"
        Parameters:
          PrivateSubnet1ID: !Ref PrivateSubnet1ID
          PrivateSubnet2ID: !Ref PrivateSubnet2ID
          TemplateBucketName: !Ref TemplateBucketName
          NodeSecurityGroup: !GetAtt EKSPreRequsiteStack.Outputs.ControlPanelSecurityGroup
          ControlPanelSecurityGroup: !GetAtt EKSPreRequsiteStack.Outputs.ControlPanelSecurityGroup
          NodeInstanceRole: !Ref NodeInstanceRole
          NodeInstanceRoleArn: !GetAtt NodeInstanceRole.Arn
          NodeInstanceType: !Ref NodeInstanceType
          MaxNumberOfNodes: !Ref MaxNumberOfNodes
          MinNumberOfNodes: !Ref MinNumberOfNodes
          DesiredNumberOfNodes: !Ref DesiredNumberOfNodes
          EKSNodeVolumeSize: !Ref EKSNodeVolumeSize
          EksClusterName: !Sub "${AWS::StackName}"
          KubernetesVersion: !Ref KubernetesVersion
          Environment: !Sub "${Environment}"

    IngressControllerPreRequsiteStack:
      #Condition: isCreateEKSPreRequsite
      Condition: isCreateEKS
      Type: AWS::CloudFormation::Stack
      DependsOn:
        - EKSNodeGroupStack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: !Sub "${AWS::StackName}-IngressControllerPreRequsite"
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/ingress-controller-prerequsite.yaml"
        Parameters:
          VpcId: !Ref VPCID
          EksClusterName: !Sub "${AWS::StackName}"
          Environment: !Sub "${Environment}"
          ControllerHostNetwork: !Ref ControllerHostNetwork

    AdminStack:
      Condition: isCreateAdmin
      Type: AWS::CloudFormation::Stack
      DependsOn: 
          - MSKStack
          - ElasticSearchStack
          - MySQLStack
          #- EKSNodeGroupStack
          - AWSQSEKSClusterStack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: !Sub "${AWS::StackName}-Admin"
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/2-subnets/admin.yaml"
        Parameters:
          Application: !Ref Application
          ApplicationReleaseChannel: !Ref ApplicationReleaseChannel
          VPCID: !Ref VPCID
          PrivateSubnet1ID: !Ref PrivateSubnet1ID
          PrivateSubnet2ID: !Ref PrivateSubnet2ID
          #ProvisionInstanceRole: !GetAtt EKSClusterStack.Outputs.ProvisionInstanceRole
          #ProvisionInstanceProfile: !GetAtt EKSClusterStack.Outputs.ProvisionInstanceProfile
          ProvisionInstanceRole: !GetAtt AWSQSEKSClusterProvisionIAMStack.Outputs.ProvisionInstanceRole
          ProvisionInstanceProfile: !GetAtt AWSQSEKSClusterProvisionIAMStack.Outputs.ProvisionInstanceProfile
          ProvisionInstanceType: !Ref ProvisionInstanceType
          ProvisionSecurityGroup: !Ref ProvisionSecurityGroup
          #NodeInstanceRoleArn: !GetAtt EKSClusterStack.Outputs.NodeInstanceRoleArn
          NodeInstanceRoleArn: !GetAtt NodeInstanceRole.Arn
          TemplateBucketName: !Ref TemplateBucketName
          Environment: !Ref Environment
          EC2LogGroup: !Ref EC2LogGroup
          EksClusterName: !Sub "${AWS::StackName}"
          K8sNamespace: !Sub "${AWS::StackName}"
          #EKSProvisionAutoScalingGroup: !GetAtt EKSClusterStack.Outputs.EKSProvisionAutoScalingGroup
          DomainName: !Ref DomainName
          KotsDomainName: !Ref KotsDomainName
          KotsAdmNLBScheme: !Ref KotsAdmNLBScheme
          MySQLEndpoint: !GetAtt MySQLStack.Outputs.ClusterEndpoint
          ElasticSearchEndpoint: !GetAtt ElasticSearchStack.Outputs.DomainEndpoint
          MSKClusterName: !Sub "${AWS::StackName}"
          ElbCertArn: !Ref ElbCertArn
          KotsElbCertArn: !Ref KotsElbCertArn
          ElbInboundCIDRs: !Ref ElbInboundCIDRs
          MasterUserPassword:
            Fn::Sub: "{{resolve:secretsmanager:${RDSSecret}::password}}"
          ESMasterUserPassword:
            Fn::Sub: "{{resolve:secretsmanager:${ESSecret}::password}}"
          KOTSUserPassword:
            Fn::Sub: "{{resolve:secretsmanager:${KOTSSecret}::password}}"
          RemoveTempResources: !Ref RemoveTempResources

    PrivateLinkStack:
      Condition: isCreatePrivateLink
      Type: AWS::CloudFormation::Stack
      DependsOn:
        - AdminStack
      Properties:
        Tags:
          - Key: Name
            Value: !Sub "${AWS::StackName}"
          - Key: Component
            Value: !Sub "${AWS::StackName}-PrivateLink"
        TemplateURL: !Sub "https://${TemplateBucketName}.s3.amazonaws.com/${Environment}/templates/nested/privatelink.yaml"
        Parameters:
          Environment: !Sub "${Environment}"
          EksClusterName: !Sub "${AWS::StackName}"

Outputs:
  ProvisionSubstackName:
    Value: !GetAtt EKSClusterStack.Outputs.SubstackName
    Condition: isCreateEKS
  ProvisionSecurityGroup:
    Value: !Ref ProvisionSecurityGroup
    Condition: isCreateEKS
  EKSProvisionLaunchConfiguration:
    Value: !GetAtt EKSClusterStack.Outputs.EKSProvisionLaunchConfiguration
    Condition: isCreateEKS
  EKSProvisionAutoScalingGroup:
    Value: !GetAtt EKSClusterStack.Outputs.EKSProvisionAutoScalingGroup
    Condition: isCreateEKS
  ProvisionInstanceRole:
    Value: !GetAtt EKSClusterStack.Outputs.ProvisionInstanceRole
    Condition: isCreateEKS
  ProvisionInstanceProfile:
    Value: !GetAtt EKSClusterStack.Outputs.ProvisionInstanceProfile
    Condition: isCreateEKS

  ElasticSearchDomainEndpoint:
    Value: !GetAtt ElasticSearchStack.Outputs.DomainEndpoint
    Condition: isCreateElasticSearch

  ControlPanelSecurityGroup:
    Value: !GetAtt EKSPreRequsiteStack.Outputs.ControlPanelSecurityGroup
    Condition: isCreateEKS
  EksClusterName:
    Value: !GetAtt EKSClusterStack.Outputs.EksClusterName
    Condition: isCreateEKS
  EksServiceRoleArn:
    Value: !GetAtt EKSPreRequsiteStack.Outputs.EksServiceRoleArn
    Condition: isCreateEKS
  NodeInstanceRoleArn:
    Value: !GetAtt NodeInstanceRole.Arn
    Condition: isCreateEKS
  AvailabilityZones:
    Value: !Join [",", !Ref AvailabilityZones]
